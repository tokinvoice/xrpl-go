# XLS-65 and XLS-66 Implementation Design

## Overview

This document describes the design and implementation plan for adding XLS-65 (Single Asset Vault) and XLS-66 (XRP Ledger-native Lending Protocol) support to the xrpl-go library.

### References

- **XLS-65 Specification**: [XRPL-Standards #210](https://github.com/XRPLF/XRPL-Standards/blob/master/XLS-0065d-single-asset-vault/README.md)
- **XLS-66 Specification**: [XRPL-Standards #211](https://github.com/XRPLF/XRPL-Standards/blob/master/XLS-0066d-lending-protocol/README.md)
- **Reference Implementation**: xrpl.js library (already implements XLS-65/66)
- **Test Network**: Lending Devnet (`wss://lend.devnet.rippletest.net:51233/`)
- **JavaScript Tests**: `xls65-66-tests/` folder (regression test reference)

---

## Part 1: XLS-65 - Single Asset Vault

### 1.1 Ledger Entry Type: Vault

**Type ID**: 132

**Purpose**: Aggregates assets from depositors and tracks ownership via Multi-Purpose Tokens (MPT).

#### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| LedgerEntryType | string | Yes | Always "Vault" |
| Index | Hash256 | Yes | Unique identifier |
| Flags | uint32 | Yes | Bit-flags (lsfVaultPrivate = 65536) |
| Sequence | uint32 | Yes | Sequence number when created |
| OwnerNode | string | Yes | Directory hint for owner |
| Owner | Address | Yes | Account that owns the vault |
| Account | Address | Yes | Pseudo-account holding assets |
| Asset | Currency | Yes | Asset type (XRP or IOU) |
| AssetsTotal | CurrencyAmount | No | Total assets in vault |
| AssetsAvailable | CurrencyAmount | No | Available assets (not locked) |
| LossUnrealized | CurrencyAmount | No | Unrealized losses |
| MPTokenIssuanceID | Hash192 | Yes | MPT Issuance ID for shares |
| WithdrawalPolicy | uint8 | Yes | Withdrawal strategy |
| AssetsMaximum | CurrencyAmount | No | Maximum assets allowed |
| Data | string | No | Arbitrary data (max 256 bytes) |
| PreviousTxnID | Hash256 | Yes | Last modifying transaction |
| PreviousTxnLgrSeq | uint32 | Yes | Ledger sequence of last modification |

#### Go Implementation

```go
// File: xrpl/ledger-entry-types/vault.go
type Vault struct {
    Index             types.Hash256          `json:"index,omitempty"`
    LedgerEntryType   EntryType
    Flags             uint32
    Sequence          uint32
    OwnerNode         string
    Owner             types.Address
    Account           types.Address
    Asset             Currency
    AssetsTotal       types.CurrencyAmount   `json:",omitempty"`
    AssetsAvailable   types.CurrencyAmount   `json:",omitempty"`
    LossUnrealized    types.CurrencyAmount   `json:",omitempty"`
    MPTokenIssuanceID string                 // Hash192
    WithdrawalPolicy  uint8
    AssetsMaximum     types.CurrencyAmount   `json:",omitempty"`
    Data              string                 `json:",omitempty"`
    PreviousTxnID     types.Hash256
    PreviousTxnLgrSeq uint32
}

func (*Vault) EntryType() EntryType { return VaultEntry }
```

### 1.2 Transactions

#### VaultCreate (Type ID: 65)

Creates a new Vault ledger object.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultCreate" |
| Account | Address | Yes | Creator's account |
| Asset | Currency | Yes | Asset type for the vault |
| Data | string | No | Arbitrary data |
| AssetsMaximum | CurrencyAmount | No | Maximum assets |
| MPTokenMetadata | string | No | Metadata for share tokens |
| WithdrawalPolicy | uint8 | No | Withdrawal strategy |
| DomainID | Hash256 | No | Permissioned domain ID |

**Flags**:
- `tfVaultPrivate` (65536): Makes vault private
- `tfVaultShareNonTransferable` (131072): Shares cannot be transferred

#### VaultSet (Type ID: 66)

Updates an existing Vault's settings.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultSet" |
| Account | Address | Yes | Vault owner |
| VaultID | Hash256 | Yes | Vault to modify |
| Data | string | No | New arbitrary data |
| AssetsMaximum | CurrencyAmount | No | New maximum assets |
| DomainID | Hash256 | No | New permissioned domain |

#### VaultDelete (Type ID: 67)

Deletes an empty Vault.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultDelete" |
| Account | Address | Yes | Vault owner |
| VaultID | Hash256 | Yes | Vault to delete |

#### VaultDeposit (Type ID: 68)

Deposits assets into a Vault.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultDeposit" |
| Account | Address | Yes | Depositor |
| VaultID | Hash256 | Yes | Target vault |
| Amount | CurrencyAmount | Yes | Amount to deposit |

#### VaultWithdraw (Type ID: 69)

Withdraws assets from a Vault.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultWithdraw" |
| Account | Address | Yes | Withdrawer (must hold shares) |
| VaultID | Hash256 | Yes | Source vault |
| Amount | CurrencyAmount | Yes | Amount to withdraw |

#### VaultClawback (Type ID: 70)

Claws back assets from a Vault (issuer only).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "VaultClawback" |
| Account | Address | Yes | Asset issuer |
| VaultID | Hash256 | Yes | Target vault |
| Amount | CurrencyAmount | Yes | Amount to claw back |
| Holder | Address | No | Specific holder to claw from |

---

## Part 2: XLS-66 - Lending Protocol

### 2.1 Ledger Entry Type: LoanBroker

**Type ID**: 136

**Purpose**: Defines lending terms and manages the relationship between a Vault and borrowers.

#### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| LedgerEntryType | string | Yes | Always "LoanBroker" |
| Index | Hash256 | Yes | Unique identifier |
| Flags | uint32 | Yes | Bit-flags |
| Sequence | uint32 | Yes | Sequence number when created |
| LoanSequence | uint32 | Yes | Next loan sequence number managed by this broker |
| OwnerNode | string | Yes | Directory hint for broker owner |
| VaultNode | string | Yes | Directory hint for associated vault |
| VaultID | Hash256 | Yes | Associated vault |
| Account | Address | Yes | Broker account |
| Owner | Address | Yes | Owner of the broker (typically same as Account) |
| OwnerCount | uint32 | No | Number of objects owned by this entry |
| DebtTotal | CurrencyAmount | No | Total outstanding debt |
| DebtMaximum | CurrencyAmount | Yes | Maximum total debt |
| CoverAvailable | CurrencyAmount | No | Available first-loss capital |
| CoverRateMinimum | uint32 | No | Minimum cover ratio |
| CoverRateLiquidation | uint32 | No | Liquidation threshold |
| PreviousTxnID | Hash256 | Yes | Last modifying transaction |
| PreviousTxnLgrSeq | uint32 | Yes | Ledger sequence |

### 2.2 Ledger Entry Type: Loan

**Type ID**: 137

**Purpose**: Represents an active loan between a borrower and a Vault.

#### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| LedgerEntryType | string | Yes | Always "Loan" |
| Index | Hash256 | Yes | Unique identifier |
| Flags | uint32 | Yes | Bit-flags |
| LoanSequence | uint32 | Yes | Loan sequence number under the broker |
| OwnerNode | string | Yes | Directory hint for loan owner |
| LoanBrokerNode | string | Yes | Directory hint for associated LoanBroker |
| LoanBrokerID | Hash256 | Yes | Associated LoanBroker |
| Borrower | Address | Yes | Borrower account |
| LoanOriginationFee | CurrencyAmount | No | One-time origination fee |
| LoanServiceFee | CurrencyAmount | No | Recurring service fee |
| LatePaymentFee | CurrencyAmount | No | Fee for late payments |
| ClosePaymentFee | CurrencyAmount | No | Fee for closing the loan |
| OverpaymentFee | CurrencyAmount | No | Fee for overpayment |
| InterestRate | uint32 | No | Interest rate (basis points) |
| LateInterestRate | uint32 | No | Late interest rate (basis points) |
| CloseInterestRate | uint32 | No | Close-out interest rate (basis points) |
| OverpaymentInterestRate | uint32 | No | Overpayment interest rate (basis points) |
| StartDate | uint32 | Yes | Loan start time (seconds since Ripple epoch) |
| PaymentInterval | uint32 | Yes | Interval between payments (seconds) |
| GracePeriod | uint32 | Yes | Grace period before default (seconds) |
| PreviousPaymentDate | uint32 | No | Time of previous payment |
| NextPaymentDueDate | uint32 | Yes | Time of next payment due |
| PaymentRemaining | uint32 | Yes | Number of payments remaining |
| PrincipalOutstanding | CurrencyAmount | Yes | Outstanding principal |
| PeriodicPayment | CurrencyAmount | Yes | Amount due each period |
| TotalValueOutstanding | CurrencyAmount | Yes | Total remaining value (principal + interest) |
| PreviousTxnID | Hash256 | Yes | Last modifying transaction |
| PreviousTxnLgrSeq | uint32 | Yes | Ledger sequence |

### 2.3 Transactions

#### LoanBrokerSet (Type ID: 74)

Creates or updates a LoanBroker.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanBrokerSet" |
| Account | Address | Yes | Vault owner / broker owner |
| VaultID | Hash256 | Yes | Associated vault |
| LoanBrokerID | Hash256 | No | Existing LoanBroker to update |
| Data | string | No | Arbitrary data |
| ManagementFeeRate | uint32 | No | Management fee rate (basis points) |
| DebtMaximum | CurrencyAmount | No | Maximum total debt |
| CoverRateMinimum | uint32 | No | Minimum cover ratio |
| CoverRateLiquidation | uint32 | No | Liquidation threshold |

#### LoanBrokerDelete (Type ID: 75)

Deletes a LoanBroker.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanBrokerDelete" |
| Account | Address | Yes | Broker owner |
| LoanBrokerID | Hash256 | Yes | LoanBroker to delete |

#### LoanBrokerCoverDeposit (Type ID: 76)

Deposits first-loss capital into a LoanBroker.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanBrokerCoverDeposit" |
| Account | Address | Yes | Depositor |
| LoanBrokerID | Hash256 | Yes | Associated LoanBroker |
| Amount | CurrencyAmount or MPTAmount | Yes | Amount to deposit |

#### LoanBrokerCoverWithdraw (Type ID: 77)

Withdraws first-loss capital from a LoanBroker.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanBrokerCoverWithdraw" |
| Account | Address | Yes | Withdrawer |
| LoanBrokerID | Hash256 | Yes | Associated LoanBroker |
| Amount | CurrencyAmount or MPTAmount | Yes | Amount to withdraw |
| Destination | Address | No | Destination for withdrawn cover (defaults to Account) |

#### LoanBrokerCoverClawback (Type ID: 78)

Claws back first-loss capital (issuer only).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanBrokerCoverClawback" |
| Account | Address | Yes | Asset issuer |
| LoanBrokerID | Hash256 | No | Associated LoanBroker |
| Amount | CurrencyAmount or MPTAmount | No | Amount to claw back |

#### LoanSet (Type ID: 80)

Creates or modifies a Loan under a LoanBroker (two-party agreement, typically requiring multi-signature between borrower and lender).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanSet" |
| Account | Address | Yes | One party to the loan (borrower or lender) |
| LoanBrokerID | Hash256 | Yes | LoanBroker managing the loan |
| PrincipalRequested | CurrencyAmount | Yes | Requested principal |
| Counterparty | Address | No | Other party to the loan |
| CounterpartySignature | Blob | No | Signature from counterparty |
| Data | string | No | Arbitrary metadata |
| LoanOriginationFee | CurrencyAmount | No | One-time origination fee |
| LoanServiceFee | CurrencyAmount | No | Recurring service fee |
| LatePaymentFee | CurrencyAmount | No | Late payment fee |
| ClosePaymentFee | CurrencyAmount | No | Close-out fee |
| OverpaymentFee | CurrencyAmount | No | Overpayment fee |
| InterestRate | uint32 | No | Interest rate (basis points) |
| LateInterestRate | uint32 | No | Late interest rate (basis points) |
| CloseInterestRate | uint32 | No | Close-out interest rate (basis points) |
| OverpaymentInterestRate | uint32 | No | Overpayment interest rate (basis points) |
| PaymentTotal | uint32 | No | Total number of payments |
| PaymentInterval | uint32 | No | Interval between payments (seconds) |
| GracePeriod | uint32 | No | Grace period (seconds) |
| Flags | uint32 | No | Bit-flags (tfLoanOverpayment) |

#### LoanDelete (Type ID: 81)

Deletes a Loan.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanDelete" |
| Account | Address | Yes | Borrower or lender |
| LoanID | Hash256 | Yes | Loan to delete |

#### LoanManage (Type ID: 82)

Manages loan state flags (default, impair, unimpair).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanManage" |
| Account | Address | Yes | Controller (typically lender) |
| LoanID | Hash256 | Yes | Loan to manage |
| Flags | uint32 | No | Bit-flags (tfLoanDefault, tfLoanImpair, tfLoanUnimpair) |

#### LoanPay (Type ID: 84)

Makes a payment on a Loan.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| TransactionType | string | Yes | "LoanPay" |
| Account | Address | Yes | Payer |
| LoanID | Hash256 | Yes | Loan to pay |
| Amount | CurrencyAmount or MPTAmount | Yes | Payment amount |

---

## Part 3: Binary Codec Updates

### 3.1 New Ledger Entry Types

Add to `binary-codec/definitions/definitions.json` in `LEDGER_ENTRY_TYPES`:

```json
"Vault": 132,
"LoanBroker": 136,
"Loan": 137
```

### 3.2 New Transaction Types

Add to `binary-codec/definitions/definitions.json` in `TRANSACTION_TYPES`:

```json
"VaultCreate": 65,
"VaultSet": 66,
"VaultDelete": 67,
"VaultDeposit": 68,
"VaultWithdraw": 69,
"VaultClawback": 70,
"LoanBrokerSet": 74,
"LoanBrokerDelete": 75,
"LoanBrokerCoverDeposit": 76,
"LoanBrokerCoverWithdraw": 77,
"LoanBrokerCoverClawback": 78,
"LoanSet": 80,
"LoanDelete": 81,
"LoanManage": 82,
"LoanPay": 84
```

### 3.3 New Fields

For all Vault/LoanBroker/Loan fields and XLS-65/66 transaction fields, the source of truth for `FIELDS` entries (including `nth` values and types) is the canonical
`definitions.json` from `ripple-binary-codec`.

**Implementation note:**

- Do **not** hand-copy `nth` values into xrpl-go; instead, mirror the field definitions from
  `xls65-66-tests/node_modules/ripple-binary-codec/dist/src/enums/definitions.json` when updating
  `binary-codec/definitions/definitions.json` in this repository.
- Ensure that, at minimum, the following field names are present with matching types:
  - Vault-related: `VaultID`, `MPTokenIssuanceID`, `AssetsTotal`, `AssetsAvailable`, `AssetsMaximum`, `LossUnrealized`, `WithdrawalPolicy`, `MPTokenMetadata`.
  - LoanBroker-related: `DebtMaximum`, `DebtTotal`, `CoverAvailable`, `CoverRateMinimum`, `CoverRateLiquidation`.
  - Loan-related: `LoanBrokerID`, `Borrower`, `LoanOriginationFee`, `LoanServiceFee`, `LatePaymentFee`, `ClosePaymentFee`, `OverpaymentFee`,
    `InterestRate`, `LateInterestRate`, `CloseInterestRate`, `OverpaymentInterestRate`, `StartDate`, `PaymentInterval`, `GracePeriod`,
    `PreviousPaymentDate`, `NextPaymentDueDate`, `PaymentRemaining`, `PrincipalOutstanding`, `PeriodicPayment`, `TotalValueOutstanding`.
  - LoanSet-related: `PrincipalRequested`, `Counterparty`, `CounterpartySignature`, `Data`, `PaymentTotal`, `Flags`.

Always validate the final `definitions.json` against the xrpl.js copy before relying on it for encoding.

---

## Part 4: Implementation Plan

### Phase 1: Binary Codec Updates (Day 1-2)

**Files to modify:**
- `binary-codec/definitions/definitions.json`

**Tasks:**
1. Add new ledger entry types (Vault, LoanBroker, Loan)
2. Add new transaction types (15 transactions)
3. Add all new field definitions
4. Verify field `nth` values match xrpl.js

### Phase 2: Ledger Entry Types (Day 3-5)

**Files to create:**
- `xrpl/ledger-entry-types/vault.go`
- `xrpl/ledger-entry-types/loan_broker.go`
- `xrpl/ledger-entry-types/loan.go`

**Files to modify:**
- `xrpl/ledger-entry-types/ledger_object.go` (add new entry type constants and factory cases)

**Tasks:**
1. Create Vault struct with all fields and JSON tags
2. Create LoanBroker struct with all fields
3. Create Loan struct with all fields
4. Add EntryType constants: `VaultEntry`, `LoanBrokerEntry`, `LoanEntry`
5. Update `EmptyLedgerObject()` factory function

### Phase 3: XLS-65 Transactions (Day 6-10)

**Files to create:**
- `xrpl/transaction/vault_create.go`
- `xrpl/transaction/vault_set.go`
- `xrpl/transaction/vault_delete.go`
- `xrpl/transaction/vault_deposit.go`
- `xrpl/transaction/vault_withdraw.go`
- `xrpl/transaction/vault_clawback.go`

**Files to modify:**
- `xrpl/transaction/tx_type.go` (add new transaction type constants)

**Tasks:**
1. Create each transaction struct embedding `BaseTx`
2. Implement `TxType()` method for each
3. Implement `Flatten()` method for each
4. Add flag constants (tfVaultPrivate, tfVaultShareNonTransferable)
5. Add TxType constants to `tx_type.go`

### Phase 4: XLS-66 Transactions (Day 11-16)

**Files to create:**
- `xrpl/transaction/loan_broker_set.go`
- `xrpl/transaction/loan_broker_delete.go`
- `xrpl/transaction/loan_broker_cover_deposit.go`
- `xrpl/transaction/loan_broker_cover_withdraw.go`
- `xrpl/transaction/loan_broker_cover_clawback.go`
- `xrpl/transaction/loan_set.go`
- `xrpl/transaction/loan_delete.go`
- `xrpl/transaction/loan_manage.go`
- `xrpl/transaction/loan_pay.go`

**Tasks:**
1. Create each transaction struct
2. Implement `TxType()` and `Flatten()` methods
3. Add flag constants for LoanSet and LoanManage (tfLoanOverpayment, tfLoanDefault, tfLoanImpair, tfLoanUnimpair)
4. Add TxType constants

### Phase 5: Integration Tests (Day 17-20)

**Files to create:**
- `xrpl/ledger-entry-types/vault_test.go`
- `xrpl/ledger-entry-types/loan_broker_test.go`
- `xrpl/ledger-entry-types/loan_test.go`
- `xrpl/transaction/vault_create_test.go`
- `xrpl/transaction/vault_set_test.go`
- ... (tests for each transaction)

**Tasks:**
1. Port JavaScript tests from `xls65-66-tests/` to Go
2. Test serialization/deserialization
3. Test against lending-devnet
4. Verify binary encoding matches xrpl.js

---

## Part 5: File Summary

### New Files (18 total)

| File | Description |
|------|-------------|
| `xrpl/ledger-entry-types/vault.go` | Vault ledger entry |
| `xrpl/ledger-entry-types/loan_broker.go` | LoanBroker ledger entry |
| `xrpl/ledger-entry-types/loan.go` | Loan ledger entry |
| `xrpl/transaction/vault_create.go` | VaultCreate transaction |
| `xrpl/transaction/vault_set.go` | VaultSet transaction |
| `xrpl/transaction/vault_delete.go` | VaultDelete transaction |
| `xrpl/transaction/vault_deposit.go` | VaultDeposit transaction |
| `xrpl/transaction/vault_withdraw.go` | VaultWithdraw transaction |
| `xrpl/transaction/vault_clawback.go` | VaultClawback transaction |
| `xrpl/transaction/loan_broker_set.go` | LoanBrokerSet transaction |
| `xrpl/transaction/loan_broker_delete.go` | LoanBrokerDelete transaction |
| `xrpl/transaction/loan_broker_cover_deposit.go` | LoanBrokerCoverDeposit transaction |
| `xrpl/transaction/loan_broker_cover_withdraw.go` | LoanBrokerCoverWithdraw transaction |
| `xrpl/transaction/loan_broker_cover_clawback.go` | LoanBrokerCoverClawback transaction |
| `xrpl/transaction/loan_set.go` | LoanSet transaction |
| `xrpl/transaction/loan_delete.go` | LoanDelete transaction |
| `xrpl/transaction/loan_manage.go` | LoanManage transaction |
| `xrpl/transaction/loan_pay.go` | LoanPay transaction |

### Modified Files (3 total)

| File | Changes |
|------|---------|
| `binary-codec/definitions/definitions.json` | Add ledger types, transaction types, fields |
| `xrpl/ledger-entry-types/ledger_object.go` | Add entry type constants and factory cases |
| `xrpl/transaction/tx_type.go` | Add transaction type constants |

---

## Part 6: Testing Strategy

### Unit Tests

1. **Struct Validation**: Test that all required fields are present
2. **JSON Marshaling**: Test JSON serialization/deserialization
3. **Binary Encoding**: Test binary codec encoding matches expected values
4. **Flag Handling**: Test flag constants and combinations

### Integration Tests

1. **Lending Devnet Connection**: Connect to `wss://lend.devnet.rippletest.net:51233/`
2. **Faucet Funding**: Use `https://lend-faucet.devnet.rippletest.net/accounts`
3. **Transaction Submission**: Submit each transaction type
4. **Ledger Entry Retrieval**: Verify ledger entries are created correctly

### Regression Tests

Port the JavaScript tests from `xls65-66-tests/` to Go:

1. `test-vault.js` → Go vault integration tests covering `VaultCreate`, `VaultDeposit`, `VaultWithdraw`, `VaultSet`, `VaultDelete`, and Vault ledger lookups.
2. `test-lending.js` → Go lending integration tests covering `VaultCreate`/`VaultDeposit` (prerequisite), `LoanBrokerSet`, `LoanBrokerCoverDeposit`, `LoanBrokerCoverWithdraw`,
   and LoanBroker ledger lookups. The `LoanSet` transaction is currently only constructed (not submitted) due to multi-signature requirements; end-to-end
   `LoanSet`/`LoanPay`/`LoanManage` flows can be added in a later phase once multi-sign orchestration is implemented in Go.

---

## Part 7: Dependencies

### Required Features (Already Implemented)

- **XLS-33 (Multi-Purpose Tokens)**: Used for vault share tokens
- **MPTokenIssuance**: Vault creates MPT for shares
- **MPToken**: Depositors receive MPT shares

### Optional Features

- **XLS-70 (Credentials)**: For permissioned vault access
- **XLS-80 (Permissioned Domains)**: For private vaults

---

## Part 8: Estimated Timeline

| Phase | Duration | Description |
|-------|----------|-------------|
| Phase 1 | 2 days | Binary codec updates |
| Phase 2 | 3 days | Ledger entry types |
| Phase 3 | 5 days | XLS-65 transactions |
| Phase 4 | 6 days | XLS-66 transactions |
| Phase 5 | 4 days | Integration tests |
| **Total** | **20 days** | ~4 weeks |

---

## Part 9: Implementation Order

Recommended order for implementation:

1. **Binary Codec** - Foundation for all other work
2. **Vault Ledger Entry** - Core XLS-65 data structure
3. **VaultCreate** - First transaction to test
4. **VaultDeposit/VaultWithdraw** - Core vault operations
5. **VaultSet/VaultDelete** - Vault management
6. **VaultClawback** - Issuer operations
7. **LoanBroker Ledger Entry** - Core XLS-66 data structure
8. **LoanBrokerSet/Delete** - Broker management
9. **LoanBrokerCoverDeposit/Withdraw/Clawback** - First-loss capital
10. **Loan Ledger Entry** - Loan data structure
11. **LoanSet/Delete** - Loan creation/deletion
12. **LoanManage** - Loan operations
13. **LoanPay** - Loan payments

---

## Appendix A: Flag Constants

### Vault Flags (VaultCreate)

```go
const (
    tfVaultPrivate            uint32 = 65536   // 0x00010000
    tfVaultShareNonTransferable uint32 = 131072 // 0x00020000
)
```

### Vault Ledger Entry Flags

```go
const (
    lsfVaultPrivate uint32 = 65536 // 0x00010000
)
```

### Loan Manage Flags

```go
const (
    tfLoanDefault  uint32 = 65536  // 0x00010000
    tfLoanImpair   uint32 = 131072 // 0x00020000
    tfLoanUnimpair uint32 = 262144 // 0x00040000
)
```

### Loan Set Flags

```go
const (
    tfLoanOverpayment uint32 = 65536 // 0x00010000
)
```

---

## Appendix B: Reference Implementation Links

- **xrpl.js Vault**: `node_modules/xrpl/dist/npm/models/ledger/Vault.d.ts`
- **xrpl.js Loan**: `node_modules/xrpl/dist/npm/models/ledger/Loan.d.ts`
- **xrpl.js LoanBroker**: `node_modules/xrpl/dist/npm/models/ledger/LoanBroker.d.ts`
- **xrpl.js Transactions**: `node_modules/xrpl/dist/npm/models/transactions/`
- **Binary Codec Definitions**: `node_modules/ripple-binary-codec/dist/src/enums/definitions.json`


